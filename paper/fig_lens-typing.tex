\begin{figure}
\centering
\begin{mathpar}
\inferrule[\ConstantLensRule{}]
{
\String_1 \in \StarOf{\Sigma}\\
\String_2 \in \StarOf{\Sigma}
}
{
\ConstLens{\String_1}{\String_2} \OfType \String_1 \Leftrightarrow \String_2 \HasSemantics \lambda \String. \String_2 , \lambda \String. \String_1
}

\inferrule[\IdentityLensRule{}]
{
}
{
\IdentityLens \OfType \Regex \Leftrightarrow \Regex \HasSemantics \lambda \String.\String, \lambda \String . \String
}

\inferrule[\IterateLensRule{}]
{
\Lens \OfType \Regex \Leftrightarrow \RegexAlt \HasSemantics \PutRight , \PutLeft \\
\UnambigItOf{\LanguageOf{\Regex}}\\
\UnambigItOf{\LanguageOf{\RegexAlt}}
}
{
\IterateLens{\Lens} \OfType \StarOf{\Regex} \Leftrightarrow \StarOf{\RegexAlt} \HasSemantics\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\ldots\Concat\String_n}{\String}{\String_i\in\LanguageOf{\Regex}} (\PutRight\Apply\String_1)\Concat\ldots\Concat(\PutRight\Apply\String_n),\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\ldots\Concat\String_n}{\String}{\String_i\in\LanguageOf{\RegexAlt}} (\PutLeft\Apply\String_1)\Concat\ldots\Concat(\PutLeft\Apply\String_n)
}

\inferrule[\ConcatLensRule{}]
{
\Lens_1 \OfType \Regex_1 \Leftrightarrow \RegexAlt_1 \HasSemantics \PutRight_1, \PutLeft_1\\
\Lens_2 \OfType \Regex_2 \Leftrightarrow \RegexAlt_2 \HasSemantics \PutRight_2, \PutLeft_2\\\\
\UnambigConcatOf{\LanguageOf{\Regex_1}}{\LanguageOf{\Regex_2}}\\
\UnambigConcatOf{\LanguageOf{\RegexAlt_1}}{\LanguageOf{\RegexAlt_2}}
}
{
\ConcatLens{\Lens_1}{\Lens_2} \OfType \Regex_1\Regex_2 \Leftrightarrow \RegexAlt_1\RegexAlt_2 \HasSemantics\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\String_2}{\String}{\String_i\in\LanguageOf{\Regex_i}} (\PutRight_1\Apply\String_1)\Concat(\PutRight_2\Apply\String_2),\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\String_2}{\String}{\String_i\in\LanguageOf{\RegexAlt_i}} (\PutLeft_1\Apply\String_1)\Concat(\PutLeft_2\Apply\String_2)
}

\inferrule[\SwapLensRule{}]
{
\Lens_1 \OfType \Regex_1 \Leftrightarrow \RegexAlt_1 \HasSemantics \PutRight_1,\PutLeft_2\\
\Lens_2 \OfType \Regex_2 \Leftrightarrow \RegexAlt_2 \HasSemantics \PutRight_1,\PutLeft_2\\\\
\UnambigConcatOf{\LanguageOf{\Regex_1}}{\LanguageOf{\Regex_2}}\\
\UnambigConcatOf{\LanguageOf{\RegexAlt_2}}{\LanguageOf{\RegexAlt_1}}
}
{
\SwapLens{\Lens_1}{\Lens_2} \OfType \Regex_1\Regex_2 \Leftrightarrow \RegexAlt_2\RegexAlt_1 \HasSemantics\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\String_2}{\String}{\String_i\in\LanguageOf{\Regex_i}} (\PutRight_2\Apply\String_2)\Concat(\PutRight_1\Apply\String_1),\\\\
\lambda \String.\LetWhereIn{\String_1\Concat\String_2}{\String}{\String_i\in\LanguageOf{\RegexAlt_i}} (\PutLeft_2\Apply\String_2)\Concat(\PutLeft_1\Apply\String_1)
}

\inferrule[\OrLensRule{}]
{
\Lens_1 \OfType \Regex_1 \Leftrightarrow \RegexAlt_1 \HasSemantics \PutRight_1,\PutLeft_1\\
\Lens_2 \OfType \Regex_2 \Leftrightarrow \RegexAlt_2 \HasSemantics \PutRight_2,\PutLeft_2\\\\
\UnambigOrOf{\LanguageOf{\Regex_1}}{\LanguageOf{\Regex_2}}\\ \UnambigOrOf{\LanguageOf{\RegexAlt_1}}{\LanguageOf{\RegexAlt_2}}
}
{
\OrLens{\Lens_1}{\Lens_2} \OfType \Regex_1 | \RegexAlt_1 \Leftrightarrow \Regex_2 | \RegexAlt_2 \HasSemantics\\\\
\lambda \String.\{\PutRight_1(\String) \text{ if $\String\in\LanguageOf{\Regex_1}$ }, \PutRight_2(\String) \text{ if $\String\in\LanguageOf{\Regex_2}$ }\},\\\\
\lambda \String.\{\PutLeft_1(\String) \text{ if $\String\in\LanguageOf{\RegexAlt_1}$ }, \PutLeft_2(\String) \text{ if $\String\in\LanguageOf{\RegexAlt_2}$ }\}
}

\inferrule[\ComposeLensRule{}]
{
\Lens_1 \OfType \Regex_1 \Leftrightarrow \Regex_2 \HasSemantics \PutRight_1,\PutLeft_1\\
\Lens_2 \OfType \Regex_2 \Leftrightarrow \Regex_3 \HasSemantics \PutRight_2,\PutLeft_2\\
}
{
\ComposeLens{\Lens_2}{\Lens_1} \OfType \Regex_1 \Leftrightarrow \Regex_3 \HasSemantics
\PutRight_2\Compose\PutRight_1,\PutLeft_2\Compose\PutLeft_1
}

\inferrule[\RetypeLensRule{}]
{
\Lens \OfType \Regex_1 \Leftrightarrow \Regex_2 \HasSemantics \PutRight,\PutLeft\\
\Regex_1 \equiv \Regex_1'\\
\Regex_2 \equiv \Regex_2'
}
{
\Lens \OfType \Regex_1' \Leftrightarrow \Regex_2' \HasSemantics \PutRight,\PutLeft
}
\end{mathpar}

\caption{Lens Semantics and Typing\bcp{This reads OK, but I still don't
    understand why it wouldn't work to define the semantics separately (and
    then show that every {\em well-typed} lens denotes a bijection).  Seems
    a bit easier for readers that way here, and significantly easier once we
    get to DNF lenses...}}
\label{fig:lens-semantics}
\end{figure}
