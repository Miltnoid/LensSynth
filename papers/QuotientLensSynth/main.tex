\newif\ifdraft\drafttrue  % set true to show comments

\documentclass{svproc}

\usepackage{amsmath, amssymb, verbatim, enumerate, 
graphicx, centernot, tikz, array, tikz-cd, extarrows, cleveref,
mathrsfs, mathtools, bussproofs, stmaryrd, enumitem, stackengine}

%%%%%
% Macros
% Colors
\definecolor{dkblue}{rgb}{0,0.1,0.5}
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{dkred}{rgb}{0.6,0,0}
\definecolor{dkpurple}{rgb}{0.7,0,0.4}
\definecolor{olive}{rgb}{0.4, 0.4, 0.0}
\definecolor{teal}{rgb}{0.0,0.5,0.5}
\definecolor{orange}{rgb}{0.9,0.6,0.2}
\definecolor{lightyellow}{RGB}{255, 255, 179}
\definecolor{lightgreen}{RGB}{170, 255, 220}
\definecolor{teal}{RGB}{141,211,199}
\definecolor{darkbrown}{RGB}{121,37,0}

\newcommand{\FINISH}[3]{\ifdraft\textcolor{#1}{[#2: #3]}\fi}
\newcommand{\bcp}[1]{\FINISH{dkred}{B}{#1}}
\newcommand{\BCP}[1]{\FINISH{dkred}{B}{\bf #1}}
\newcommand{\afm}[1]{\FINISH{dkgreen}{A}{#1}}
\newcommand{\dpw}[1]{\FINISH{dkblue}{D}{#1}}
\newcommand{\saz}[1]{\FINISH{orange}{SZ}{#1}}
\newcommand{\ksf}[1]{\FINISH{teal}{K}{#1}}
\newcommand{\sm}[1]{\FINISH{dkpurple}{SM}{#1}}

% FOR Regular Expression names
\newcommand{\re}[1]{\ensuremath{\mathit{#1}}}

\begin{document}
\mainmatter              % start of a contribution
%
\title{Synthesizing Quotient Lenses}
%
\titlerunning{Synthesizing Quotient Lenses}  % abbreviated title (for running
% head)                                     also used for the TOC unless
%                                     \toctitle is used
%
\author{}
%
\authorrunning{} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
\tocauthor{}
%
\institute{}

\maketitle              % typeset the title of the contribution

\begin{abstract}

\keywords{quotient lenses, quotient regular expressions, synthesis}
\end{abstract}

\section{Introduction}
\saz{We need a more gentle ramp-up to the example here.}

\begin{itemize}
\item Lens programming languages [e.g. Boomerang] are designed to make it possible to express
  bidirectional data transformations using a single program.  

\item Lenses have found practical application in Augeas \saz{and ...}


\item The source and target types of a lens express constraints on the format of
  the data.

\item Lens programming is still quite tricky, because lens composition operators
  are subject to side conditions (e.g. unique decomposition) that are not so
  easy to reason about.

\item Our prior work~\cite{popl18} has shown how to synthesize lenses for the
  \textit{bijective} case.

\item This still isn't as expressive as one would want in practice, because many
  lens transformations aren't truly bijective.

\item There are at least two challenges with programming quotient lenses: (1)
  defining the quotient languages (which serve as the types of the lenses)
  themselves is not so easy, and (2) the lenses themselves are still not easy to
  write by hand.

\end{itemize}

String quotient lenses enable one to express bidirectional string
transformations that obey the lens laws up to equivalence relations. However,
the various approaches that have been proposed to express quotient lenses
make it difficult for the programmer to express complicated equivalence
relations over the data.

For example, when converting \textsc{Bib}\TeX{} files to EndNote files, the data
may contain arbitrary amounts of whitespace characters in between the actual
data. In addition, the fields may be ordered in an arbitrary order. For
instance, we may wish to convert this \textsc{Bib}\TeX{} entry: \saz{I propose
  we display such examples in verbatim:}

\begin{verbatim}
@Book {conway,
  Author = {Conway, J. H.},
  Title = {Regular Algebra and Finite Machines},
  Publisher = {Printed in GB by William Clowes & Sons Ltd},
  Year = {1971}
}
\end{verbatim}

to this EndNote entry:


\begin{verbatim}
%0 Book
%T Regular Algebra and Finite Machines
%A Conway, J. H.
%D 1971
%I Printed in GB by William Clowes & Sons Ltd
%F conway
\end{verbatim}

\noindent while allowing for this equivalent representation of the \textsc{Bib}\TeX{}
entry, which rearranges the fields and uses different  whitespace conventions:

\begin{verbatim}
@Book{conway, 
    Publisher = {Printed in GB by William Clowes & Sons Ltd},
        Title = {Regular Algebra and Finite Machines},

         Year = {1971},
       Author = {Conway, J. H.},
}
\end{verbatim}

With the existing tools, it is cumbersome to express this, and other complicated
equivalence relations.  \saz{It might be a good idea to show what this would
  look like in all its gory detail, just to make the problem very
  concrete. Perhaps in a figure?}


In this paper, we introduce the formalism of Quotient Regular Expressions (or
QREs) to solve this problem. QREs enable the programmer to express an
equivalence relation at internal terms of a regular expression, thus giving
the programmer more control over where quotienting occurs in the data.\\
For example, the fields of a \textsc{Bib}\TeX{} article like in the example
above might be expressed by the following QRE:

$$perm(\re{REF}, \re{AUTHOR}, \re{TITLE}, \re{PUBLISHER}, \re{YEAR}) \; with \; (\re{WSP}^* \mapsto \string
\n),$$ 

\noindent where $\re{REF}, \re{AUTHOR}, \re{TITLE}, \re{PUBLISHER},$ and $\re{YEAR}$ are
regular expressions describing the respective \textsc{Bib}\TeX\; fields of the
same name. The QRE of an EndNote article is similarly expressed, but with the
regular expressions for the respective fields substituted with the appropriate
EndNote equivalent.  \saz{Do we really mean all \re{WSP} maps to newline here?
  What about the spaces in the title, etc.?  Would this be confusing without
  more explanation?}

\sm{[Mention and give examples of quotient lenses here?]}

\subsection{Contributions}
\begin{enumerate}
  \item
  We introduce the language of Quotient Regular Expressions (QREs) which enables
  us to express a set of equivalence relations on regular languages using a
  compact, easy-to-use syntax.
  \item
  We describe a class $\mathcal{Q}$ of quotient lenses whose types are given by
  QREs. We derive a normal form for quotient lenses in $\mathcal{Q}$, and
  demonstrate that elements of $\mathcal{Q}$ that are in this normal form are
  closed under left quotienting, right quotienting, composition and regular
  operators.
  \item
  Using the normal form for quotient lenses in $\mathcal{Q}$, we reduce the
  synthesis of quotient lenses in $\mathcal{Q}$ to the synthesis of bijective
  lenses between regular languages. 
  \item
  We describe an implementation of QREs, the language $\mathcal{Q}$ of quotient
  lenses, and an algorithm for synthesizing quotient lenses in $\mathcal{Q}$ in
  the Boomerang language.
  \item
  We assess the usabibility of the QRE synthesis via a case study in which we
  selected several data formats used by data.gov and synthesized quotient lenses
  between them.
\end{enumerate}

\section{Quotient Regular Expressions}

\saz{Need a transition here:  This section introduces QREs.  They are regular
  expressions augmented with syntax that lets them simultaneously denote
  quotient languages.  
   }

  \paragraph{Syntax of QREs}
The language of Quotient Regular Expressions (QREs) is given by the following
grammar:
\begin{align*}
q := \; &R \; | \; q \mapsto s \; | \; squash (R, R', f) \; | \;
perm \; (q_1, \ldots, q_n) \; with \; q \; | \; normalize(R, R', f)\\
&q' \circ q \; | \; q \cdot q' \; | \; (q \; | \; q') \; | \; q^*,
\end{align*}
where $R$ ranges over regular expressions, $f$ ranges over functions whose
domain and codomain are regular languages, and $s$ ranges over character
strings.

\saz{  Every regular expression $R$ is a QRE.  The main new syntactic forms are: $q \mapsto s$, which
}

\saz{Would it be simpler to include atoms and $\epsilon$ in $q$ rather than $R$?  That is, $R$ is
  just a subset of $QRE$ built from atoms, $\cdot$ $|$ and ${}^*$.  We could
  reserve $R$ as a metavariable that ranges over $q$'s such that $q$ is a
  regular expression.}

\saz{Need to introduce $\mathcal{L}(R)$ notation.}

Quotient Regular Expressions (or QREs) enable us to give richer specifications
for data formats than ordinary regular expressions. More concretely, each
Quotient Regular Expression (or QRE) $q$ enables us to express
\begin{enumerate}
  \item a regular expression $W(q)$ (the ``whole'' of $q$),
  \item an equivalence relation $EqRel(q)$ on $\mathcal{L}(W(q))$,
  \item a regular expression $K(q)$ (the ``kernel'' of $q$)
  such that $\mathcal{L}(K(q))$ forms a complete set of representatives for
  $EqRel(q)$, and
  \item a ``canonizing'' function $Canonizer(q):\mathcal{L}(W(q))
  \longrightarrow \mathcal{L}(K(q))$ which given any $w \in \mathcal{L}(W(q))$,
  computes $Canonizer(q)(w)$ as the unique $k$ in $\mathcal{L}(K(q))$ such that
  $k$ is equivalent to $w$ mod $EqRel(q)$
  \end{enumerate}
  All data to be transformed must match $W(q)$, the ``whole'' regular
  expression of $q$. However, before transforming the using a lens, the data
  will be quotiented out by the equivalence relation $EqRel(q)$ which has $K(q)$
  as a complete set of representatives. That is, for each string $w \in
  W(q)$, there is a unique $k \in K(q)$ such that $w \; EqRel(q) \; k$). This
  unique representative $k$ is chosen using the ``canonizing'' function
  $Canonizer(q)$.\\
  Observe that since $Canonizer(q)$ computes $Canonizer(q)(w)$ as the unique $k$
  in $\mathcal{L}(K(q))$ such that $w$ is equivalent to $k$ mod $EqRel(q)$,
  then the equivalence classes of $EqRel(q)$ are the same as the fibres of
  $Canonizer(q)$.
\subsection{Semantics of QREs}
\subsubsection{Preliminaries}
The transformations that will be performed on the data will require
that the data is matched against regular expressions. Consequently, we require
that regular expressions used by QREs be \textit{strongly unambiguous}, a
condition which ensures that if a string $s$ matches a regular expression $R$,
then $s$ matches $R$ uniquely.

\saz{Solomon: you should use blank lines instead of backslashes to separate
  paragraphs so latex can format them properly.}

To this end, we say that regular expressions $R$ and $S$ are
\textit{unambiguosly concatenable}, written $R \cdot^! S$ if for all strings
$r, r' \in \mathcal{L}(R)$ and $s, s' \in \mathcal{L}(S)$, if $r \cdot s = r'
\cdot s'$, then $r = r'$ and $s = s'$. We say that a regular expression $R$ is
\textit{unambiguosly iterable}, written $R^{*!}$ if for all strings $r_1,
\ldots, r_m$ and $r'_1, \ldots, r'_n \in \mathcal{L}(R)$, if $r_1 \cdot \ldots
\cdot r_m = r'_1 \cdot \ldots \cdot r'_n$, then $m = n$ and $r_i = r'_i$.

We say that a regular expression $R$ is \textit{strongly unambiguous} if and
only if (1) $R = \varnothing$, or (2) $R = S_1 \cdot S_2$ with $S_1, S_2$
strongly unambiguous and $S_1 \cdot^! S_n$, or (3) $R = S_1 \; | \; S_2$ with
$S_1, S_2$ strongly unambiguous and $\mathcal{L}(S_1) \cap \mathcal{L}(S_2) =
\varnothing$, or (4) $R = S^*$ with $S$ strongly unambiguous and $S^{*!}$.

We now give the semantics of QREs as well as inference rules for deriving them:
\textcolor{red}{[Informal Meanings/Example Usages Needed]}\\
\begin{enumerate}
  \item $q = R$
\begin{center}
\begin{enumerate}
  \item $W(R) = R$,
  \item $K(R) = R$, 
  \item
For all $w, w' \in W(R)$, $w \; EqRel(q) \; w'$ if and only if $w =
w'$.
\item
$Canonizer(R)(r) = r$
\end{enumerate}
\begin{prooftree}
\AxiomC{}
\UnaryInfC{$R$ is well formed}
\end{prooftree}
\end{center}
\item $q=q \mapsto s$
\begin{center}
\begin{enumerate}
  \item $W(q \mapsto s) = W(q)$,
  \item $K(q \mapsto s) = s$, 
  \item
For all $w, w' \in W(q \mapsto S)$, $w \; EqRel(q \mapsto S) \; w'$,
\item
$Canonizer(q \mapsto S)(r) = s$
\end{enumerate}
\begin{prooftree}
\AxiomC{$s \in W(q)$}
\UnaryInfC{$q \mapsto s$ is well formed}
\end{prooftree}
\end{center}
\item $q=squash(R, R', f)$
\begin{center}
\begin{enumerate}
  \item $W(squash(R, R', f)) = R \; | \; R'$,
  \item $K(squash(R, R', f)) = R'$, 
  \item
For all $w, w' \in W(squash(R, R', f))$, $w \; EqRel(q) \; w'$ if and only
if $f(w) = w'$ or $w = w'$
\item
$Canonizer(squash(R, R', f))(w) = 
\begin{cases}
f(w) & \text{if } w \in \mathcal{L}(R)\\
w & \text{otherwise}
\end{cases}$
\end{enumerate}
\begin{prooftree}
\AxiomC{$\mathcal{L}(R) \cap \mathcal{L}(R') = \varnothing$}
\AxiomC{$f : \mathcal{L}(R) \longrightarrow \mathcal{L}(R')$}
\BinaryInfC{$squash(R, R', f)$ is well formed}
\end{prooftree}
\end{center}
\item $q=perm \; (q_1, \ldots, q_n) \; with \; q$. Given regular expressions
$R_1, \ldots, R_n$ and $S$, let $\prod({R_i}, S) = R_1 \cdot S \cdot \ldots
\cdot S \cdot R_n$.
\begin{center}
\begin{enumerate}
  \item $W(perm \; (q_1, \ldots, q_n) \; with \; q) = \bigcup \limits_{\sigma
  \in S_n} W(q_{\sigma(1)}) \cdot W(q) \cdot \ldots \cdot \cdot W(q) \cdot
  W(q_{\sigma(n)}),$
  \item $K(perm \; (q_1, \ldots, q_n) \; with \; q) = K(q_1) \cdot K(q_1)
  \cdot \ldots \cdot \cdot K(q) \cdot K(q_n)$, 
  \item
For all $w, w' \in W(q)$,  $w \; EqRel(q) \; w'$ if and only if
   $$w = r_{\sigma(1)} \cdot s_1 \cdot \ldots \cdot s_{n-1} \cdot
    r_{\sigma(n)} \text{ and } r' = {r'}_{\theta(1)} \cdot s'_1 \cdot \ldots
    \cdot s'_{n-1} \cdot {r'}_{\theta(n)}$$ for some $\sigma, \theta \in
    S_n$, with $r_i \; EqRel(q_i) \; r'_i$ and $s_k \; EqRel(q) \; s'_{k}$.
\item
$Canonize(q)(r_{\sigma(1)}
\cdot s_1 \cdot \ldots \cdot s_{n-1} \cdot r_{\sigma(n)}) \newline
= (Canonize(q_1)(r_1)) \cdot (Canonize(q)(s_1)) \cdot \ldots \cdot \cdot \cdot
(Canonize(q_n)(r_n))$
\end{enumerate}
\begin{prooftree}
\AxiomC{$\forall \sigma \neq \theta, \; \prod(\{W(q_{\sigma(i)})\}, W(q))\cap
 \prod(\{W(q_{\theta(i)})\}, W(q)) = \varnothing$}
\AxiomC{$\forall \sigma, \; K(q_{\sigma(1)}) \cdot^! K(q) \cdot^! \ldots 
\cdot^! K(q_{\sigma(n)})$}
\BinaryInfC{$permute \; (q_1, \ldots, q_n) \; with \;  q$ is well formed}
\end{prooftree}
\end{center}

\item $q = normalize(R, R', f)$
\begin{center}
\begin{enumerate}
  \item
$W(normalize(f)) = R$
\item
$K(normalize(f)) = R'$
\item For all $w, w' \in W(q)$, $w \; EqRel(q) \; w'$ if and only if
$f(w)=f(w')$
\item
$Canonize(normalize(f)) = f$
\begin{prooftree}
\AxiomC{$\mathcal{L}(R') \subseteq \mathcal{L}(R)$}
\AxiomC{$f : \mathcal{L}(R) \longrightarrow \mathcal{L}(R')$}
\AxiomC{$f$ is surjective}
\AxiomC{$f = f^2$}
\QuaternaryInfC{$normalize \; (R,R', f)$ is well formed}
\end{prooftree}
\end{enumerate}
\end{center}
\item $q=q' \circ q$
\begin{center}
\begin{enumerate}
  \item $W(q' \circ q) = W(q)$,
  \item $K(q' \circ q) = K(q')$, 
  \item
For all $w, w' \in W(squash(R, R', f))$, $w \; EqRel(q' \circ q) \; w'$ if and
only $$\text{there exist }k, k' \in
  \mathcal{L}(K(q)) \text{ such that } w \; EqRel(q) \; k, \; w' \;
  EqRel(q) \; k', \text{ and } k \; EqRel(q') \; k' $$
\item
$Canonizer(q' \circ q) = Canonizer(q') \circ Canonizer(q)
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$K(q) = W(q')$}
\TrinaryInfC{$q' \circ q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q \cdot q'$
\begin{center}
\begin{enumerate}
  \item $W(q \cdot q') = W(q) \cdot W(q')$,
  \item $K(q \cdot q') = K(q) \cdot K(q')$, 
  \item
For all $w, w' \in W(q \cdot q')$, $w \; EqRel(q' \cdot q) \; w'$ if and
only $$w = r_1
      \cdot r_2, \; w' = {r'}_1 \cdot {r'}_2 \text{ with } r_1 \; EqRel(q) \;
      {r'}_1, \; r_2 \; EqRel(q') \; {r'}_2$$
\item
$Canonizer(q \cdot q') = Canonizer(q) \cdot Canonizer(q')
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$W(q) \cdot^! W(q')$}
\AxiomC{$K(q) \cdot^! K(q')$}
\QuaternaryInfC{$q \cdot q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q \; | \;  q'$
\begin{center}
\begin{enumerate}
  \item $W(q \cdot q') = W(q) \; | \; W(q')$,
  \item $K(q \cdot q') = K(q) \; | \; K(q')$, 
  \item
For all $w, w' \in W(q \; | \; q')$, $w \; EqRel(q' \; | \; q) \; w'$ if and
only if 
$$w \; EqRel(q) \; w' \text{ or } \; w \; EqRel(q') \; w'$$
\item
$Canonizer(q \; | \; q') = Canonizer(q) \; | \; Canonizer(q')
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$W(q) \cap W(q') = \varnothing$}
\TrinaryInfC{$q \cdot q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q'^*$
\begin{center}
\begin{enumerate}
  \item $W(q'^*) = W(q')^*$,
  \item $K(q'^*) = K(q')^*$, 
  \item
For all $w, w' \in W(q'^*)$, $w \; EqRel(q'^*) \; w'$ if and
only if 
$$w = r_1 \cdot \ldots \cdot r_n, \; w' = {r'}_1 \cdot \ldots
      \cdot {r'}_n \text{ and } r_i \; EqRel(q) \; {r'}_i
      \text{ for all } 1 \leq i \leq n$$
      \item
$Canonizer(q'^*) = Canonizer(q')^* $
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$W(q)^{*!}$}
\AxiomC{$K(q)^{*!}$}
\TrinaryInfC{$q^*$ is well formed}
\end{prooftree}
\end{center}
\end{enumerate}
\begin{claim}
If $q$ is a well formed QRE, then
\begin{enumerate}
  \item  $EqRel(q)$ is an equivalence relation on $\mathcal{L}(W(q))$,
  \item  $\mathcal{L}(K(q))$ forms a complete set of representatives for
  $EqRel(q)$,
  \item $Canonizer(q):\mathcal{L}(W(q)) \longrightarrow \mathcal{L}(K(q))$ is a
  well-defined function, and
  \item  given any $w \in \mathcal{L}(W(q))$, $Canonizer(q)(w)$ is the unique
  $k$ in $\mathcal{L}(K(q))$ such that $k$ is equivalent to $w$ modulo
  $EqRel(q)$.
  \end{enumerate}
\end{claim}
\section{Using QREs to Express Quotient Lenses}
Given regular expressions $R, S$ and equivalence relations $\sim_R, \sim_S$ are
defined on $\mathcal{L}(R)$ and $\mathcal{L}(S)$ respectively, a
\textit{quotient lens} $q :
R/{\sim_R}{\Longleftrightarrow} S/{\sim_S}$ from $R$ to $S$ is
a pair of functions $q.get:
\mathcal{L}(R) \longrightarrow \mathcal{L}(S)$ and $q.put : \mathcal{L}(S)
\longrightarrow \mathcal{L}(R)$ such that
\begin{align*}
q.put \; (q.get \; r) &\sim_R r\\
q.get \; (q.put \; s) &\sim_S s
\end{align*}
Additionally the components of $q$ must respect $\sim_R$ and $\sim_S$ i.e.
if $r \sim_R r'$ and $s \sim_S s'$ then $q.get \; r \; \sim_S q.get \; r'$
and $q.put \; s \sim_R q.put \; s' \; s'$.\\
Now let $c, c'$ be QREs. Since $K(c)$ and $K(c')$ form a complete set of
representatives for $W(c)$ modulo $EqRel(c)$ and $W(c')$ modulo $EqRel(c')$
respectively, then given a bijection $\ell : K(c) \Leftrightarrow K(c')$, we
may define a quotient lens $q : W(c)/EqRel(c) \Leftrightarrow
W(c')/EqRel(c')$ by 
\begin{align*}
q.get &= \ell \circ Canonizer(c)\\
q.put &= \ell^{-1} \circ Canonizer(c')
\end{align*}
Define the class of \textit{bijective
lenses} to be the set of bijections between regular languages created from Boomerang lens combinators.
The syntax for the language of bijective lenses is given by
$$\ell := R \; | \; const(s, s') \; | \;  swap(\ell,
\ell) \; | \; \ell \cdot \ell' \; |  \; (\ell \; | \; \ell') \; | \; \ell^* \;
| \; \ell \circ \ell',$$ where $R$ ranges over regular expressions and $s$
ranges over character strings.\\
The denotation of a bijective lens $\ell$ is a function from 
$\llbracket e \rrbracket$ of a bijective lens $\ell$ is defined
inductively by
\begin{align*}
\llbracket R \rrbracket &= \{(r, r) \; | \; r \in \mathcal{L}(R)\}\\
\llbracket swap(\ell, \ell') \rrbracket &= \{(s \cdot t, t' \cdot s') \; | \;
(s, s') \in \llbracket \ell \rrbracket \text{ and } (t, t') \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell \cdot \ell' \rrbracket &= \{(s \cdot t, s' \cdot t) \; | \;
(s, s') \in \llbracket \ell \rrbracket \text{ and } (t, t') \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell \; | \; \ell' \rrbracket &= \{(s \cdot t) \; | \;
(s, t) \in \llbracket \ell \rrbracket \text{ or } (s, t) \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell^* \rrbracket &= \{(s_1 \cdot \ldots \cdot s_n, t_1 \cdot \ldots
\cdot t_n) \; | \; (s_i, t_i) \in \llbracket \ell \rrbracket \text{ for } 1
\leq i \leq n\}
\end{align*}
\textcolor{red}{[More explanation needed esp. inference rules for bijective
lenses]}\\
Having described the class of bijective lenses, we now define the class
$\mathcal{Q}$ of quotient lenses, whose language is defined inductively by the
following grammar:
$$ q := id(\ell) \; | \; lquot(q, \ell) \; | \; rquot(\ell, q) \; | \; q
\cdot q_2 \; | \; (q \; | \; q') \; | \; q^* \; | \; q \circ q',$$
where $\ell$ ranges over bijective lenses 
\subsection{Semantics of $\mathcal{Q}$}
Every element in $\mathcal{Q}$ has a type $q :
c \Longleftrightarrow c'$ where $c$ and $c'$ are QREs. The denotation
$\llbracket q \rrbracket$ of an element $q : c \Longleftrightarrow c'$ is a
quotient lens $\llbracket q \rrbracket :
W(c)/{EqRel(c)} \Longleftrightarrow W(c')/{EqRel(c')}$.\\
\textcolor{red}{[Informal Meaning/Usages Needed]}\\We now give the
semantics of $\mathcal{Q}$, as well as inference rules that may be used to
derive elements of $\mathcal{Q}$:
\begin{enumerate}
  \item
  if $q = id(\ell)$, then
  \begin{prooftree}
\AxiomC{$\ell : R \Leftrightarrow S$}
\UnaryInfC{$id(\ell): R \Leftrightarrow id(S)$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &=  \llbracket \ell \rrbracket, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1}
  \end{align*}
 
  \item if $q = lquot(c, q')$, then
\begin{prooftree}
\AxiomC{$q' : c'  \Leftrightarrow c''$}
\AxiomC{$c$ is well formed}
\AxiomC{$K(c) = W(c')$}
\TrinaryInfC{$lquot(c, q'): c' \circ c \Leftrightarrow c''$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get  &= \llbracket q'
  \rrbracket.get \circ Canonizer(c)\\
  \llbracket q \rrbracket.put &= \llbracket q' \rrbracket.put
  \end{align*}
  \item
  if $q = rquot(q', c'')$, then
  \begin{prooftree}
  \AxiomC{$q' : c \Leftrightarrow c'$}
  \AxiomC{$c''$ is well formed}
  
\AxiomC{$K(c'') = W(c')$}
\TrinaryInfC{$rquot(q', c):c \Leftrightarrow c'' \circ c'$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q'
  \rrbracket.get\\
  \llbracket q \rrbracket.put &= \llbracket q'
  \rrbracket.put \circ Canonizer(c'')
  \end{align*}
  
  \item
  $q = q_2 \circ q_1$, then
  \begin{prooftree}
\AxiomC{$q_1 : c \Leftrightarrow c'$}
\AxiomC{$q_2 : c' \Leftrightarrow c''$}
\BinaryInfC{$q_2 \circ q_1: c \Leftrightarrow c''$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_2 \rrbracket.get\circ \llbracket
  q_1 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \circ \llbracket
  q_2 \rrbracket.put
  \end{align*}
  \item
  $q = {q'}^*$, then
    \begin{prooftree}
\AxiomC{$q' : c \Leftrightarrow c'$}
\AxiomC{$W(c)^{*!}$ and $W(c')^{*!}$}
\AxiomC{$K(c)^{*!}$ and $K(c')^{*!}$}
\TrinaryInfC{${q'}^* : c^* \Leftrightarrow {c'}^*$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= (\llbracket q' \rrbracket.get)^*, \text{
  and }\\
  \llbracket q \rrbracket.put &= (\llbracket q' \rrbracket.put)^*
  \end{align*}

  \item
  $q = q_1 \cdot q_2$, then
    \begin{prooftree}
\AxiomC{$q_1 : c_1 \Leftrightarrow d_1 $}
\AxiomC{$q_2 : c_2 \Leftrightarrow d_2$}
\AxiomC{${\substack{W(c_1) \cdot^! W(c_2)\\ K(c_1) \cdot^! K(c_2)}}$}
\AxiomC{${\substack{W(d_1) \cdot^! W(d_2)\\ K(d_1) \cdot^! K(d_2)}}$}
\QuaternaryInfC{$q_1 \cdot q_2: c_1 \cdot c_2
\Leftrightarrow d_1 \cdot d_2$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_1 \rrbracket.get \cdot \llbracket
  q_2 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \cdot \llbracket
  q_2 \rrbracket.put
  \end{align*}

  \item
  $q = q_1 \; | \; q_2$, then
      \begin{prooftree}
\AxiomC{$q_1 : c_1 \Leftrightarrow d_1 $}
\AxiomC{$q_2 : c_2 \Leftrightarrow d_2$}
\AxiomC{$\mathcal{L}(W(c_1)) \cap \mathcal{L}(W(c_2)) = \varnothing$}
\AxiomC{$\mathcal{L}(W(d_1)) \cap \mathcal{L}(W(d_2)) = \varnothing$}
\QuaternaryInfC{$q_1 \; | \; q_2: (c_1 \; | \; c_2)
\Leftrightarrow (d_1 \; | \; d_2)$}
\end{prooftree}
  $$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket q_2 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_2))\\
  \end{cases}$$
  $$\llbracket q_1 \; | \; q_2 \rrbracket.put(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_1))\\
  \llbracket q_2 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_2))\\
  \end{cases}
  $$
\end{enumerate}

\begin{claim}
If there exists a derivation $q:c \Leftrightarrow c'$ then
$\llbracket q \rrbracket$ is a quotient lens from $R$ to $S$.
\end{claim}

\subsection{Normal Forms for Quotient Lenses in $\mathcal{Q}$}
\begin{theorem}\label{normal form}
If there is a derivation $q : c \Leftrightarrow c'$ in
$\mathcal{Q}$ then there exists a bijective lens $\ell : K(c) \Leftrightarrow
K(c')$ such that
\begin{align*}
\llbracket q \rrbracket.get &= \llbracket \ell \rrbracket\circ Canonizer(c)\\
\llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
Canonizer(c')
\end{align*}
\end{theorem}
\begin{proof}
Assume that $q : c \Leftrightarrow c'$. We proceed by induction over the
derivation $q : c \Leftrightarrow c'$.
\begin{enumerate}
  \item
  $id(\ell): R \Leftrightarrow id(S)$ where $\ell : R \Leftrightarrow
S$. Then
  \begin{align*}
  \llbracket id(\ell) \rrbracket.get &=  \llbracket \ell \rrbracket = \llbracket \ell \rrbracket \circ
  id_{\mathcal{L}(R)} = \llbracket \ell \rrbracket \circ Canonizer(R), \text{ and }\\
  \llbracket id(\ell) \rrbracket.put &= \llbracket \ell \rrbracket^{-1} = \llbracket \ell \rrbracket^{-1} \circ
  id_{\mathcal{L}(S)} = \llbracket \ell \rrbracket^{-1} \circ Canonizer(id(S))
  \end{align*}
  \item
  $lquot(c, q'): c' \circ c \Leftrightarrow c''$ where $q' : c' 
  \Leftrightarrow c''$, $c$ is well formed and $K(c) = W(c')$. Then
\begin{align*}
  \llbracket q \rrbracket.get  &= \llbracket q'
  \rrbracket.get \circ Canonizer(c)\\
  \llbracket q \rrbracket.put &= \llbracket q' \rrbracket.put
  \end{align*}
  By the induction hypothesis, there exists a bijective lens $\ell :
  K(c') \Leftrightarrow K(c'')$ such that 
  \begin{align*}
\llbracket q' \rrbracket.get &= \llbracket \ell \rrbracket \circ Canonizer(c')\\
\llbracket q' \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
Canonize(c'')
\end{align*}
Consequently
\begin{align*}
  \llbracket q \rrbracket.get  &= (\llbracket \ell \rrbracket \circ
  Canonizer(c')) \circ Canonizer(c) = \llbracket \ell \rrbracket \circ
  (Canonizer(c' \circ c))\\
  \llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
  Canonize(c'')
  \end{align*}

  \item
  $rquot(q', c''):c \Leftrightarrow c'' \circ c'$ where $q' : c \Leftrightarrow
  c'$, $c''$ is well formed and $K(c'') = W(c')$. Proceed as in the previous
  case.
\item
$q_2 \circ q_1: c \Leftrightarrow c''$ where $q_1 : c \Leftrightarrow c'$ and
$q_2 : c' \Leftrightarrow c''$. Then
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_2 \rrbracket.get\circ \llbracket
  q_1 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \circ \llbracket
  q_2 \rrbracket.put
  \end{align*}
  By the induction hypothesis, there exist bijective lenses
  $\ell_1 :
  K(c) \Leftrightarrow K(c')$ and $\ell_2 : K(c') \Leftrightarrow K(c'')$ such
  that
  \begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(c')
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonize(c')\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonize(c'')
\end{align*}
Consequently,
\begin{align*}
\llbracket q_2 \rrbracket.get \circ \llbracket q_1 \rrbracket.get &=
(\llbracket \ell_2 \rrbracket \circ Canonizer(c')) \circ (\llbracket \ell_1
\rrbracket \circ Canonizer(c))\\
&= \llbracket \ell_2 \rrbracket \circ (Canonizer(c') \circ \llbracket \ell_1
\rrbracket) \circ Canonizer(c)\\
&= (\llbracket \ell_2 \rrbracket \circ \llbracket \ell_1 \rrbracket) \circ
Canonizer(c)\\
&= \llbracket \ell_2  \circ  \ell_1 \rrbracket \circ
Canonizer(c)
\end{align*} 
A similar argument shows that 
$$\llbracket q_1 \rrbracket.put \circ \llbracket q_2 \rrbracket.put =
\llbracket \ell_2  \circ  \ell_1 \rrbracket^{-1} \circ
Canonizer(c)$$
\item  
${q'}^* : c^* \Leftrightarrow {c'}^*$ where $q' : c \Leftrightarrow c'$,
$W(c)^{*!}$ and $W(c')^{*!}$ and $K(c)^{*!}$ and $K(c')^{*!}$. Then
  \begin{align*}
  \llbracket {q'}^* \rrbracket.get &= (\llbracket q' \rrbracket.get)^*, \text{
  and }\\
  \llbracket {q'}^* \rrbracket.put &= (\llbracket q' \rrbracket.put)^*
  \end{align*}
  By the induction hypothesis there exists a bijective lens $\ell : K(c)
  \Leftrightarrow K(c')$ such that 
   that
  \begin{align*}
\llbracket q' \rrbracket.get &= \llbracket \ell \rrbracket \circ
Canonizer(c)\\
\llbracket q' \rrbracket.put &= {\llbracket \ell \rrbracket}^{-1} \circ
Canonizer(c')
\end{align*}
Consequentlty
\begin{align*}
\llbracket {q'}^* \rrbracket.get &= (\llbracket \ell \rrbracket \circ
Canonizer(c))^* = \llbracket \ell \rrbracket^* \circ
Canonizer(c)^* = \llbracket \ell^* \rrbracket \circ
Canonizer(c^*)\\
\llbracket {q'}^* \rrbracket.put &= (\llbracket \ell \rrbracket^{-1} \circ
Canonizer(c'))^* = (\llbracket \ell \rrbracket^{-1})^* \circ
Canonizer(c')^* = \llbracket \ell^* \rrbracket^{-1} \circ
Canonizer(c'^*)\\
\end{align*}
\item
  $q_1 \cdot q_2: c_1 \cdot c_2 \Leftrightarrow d_1 \cdot d_2$, where $q_1 : c_1
  \Leftrightarrow d_1 $,  $q_2 : c_2 \Leftrightarrow d_2$, $W(c_1)
  \cdot^! W(c_2)$, $K(c_1) \cdot^! K(c_2)$, $W(d_1) \cdot^! W(d_2)$ and $
  K(d_1) \cdot^! K(d_2)$. Then
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_1 \rrbracket.get \cdot \llbracket
  q_2 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \cdot \llbracket
  q_2 \rrbracket.put
  \end{align*}
By the induction hypothesis, there exist bijective lenses $\ell_1 : K(c_1)
\Leftrightarrow K(d_1)$ and $\ell_2 : K(c_2) \Leftrightarrow K(d_2)$ such that
\begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(d_1)
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2)\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonizer(d_2)
\end{align*}
Consequently,
\begin{align*}
  \llbracket q \rrbracket.get &= (\llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)) \cdot  (\llbracket \ell_2 \rrbracket \circ
Canonizer(c_2))\\
&= (\llbracket \ell_1 \rrbracket \cdot \llbracket \ell_2
\rrbracket) \circ (Canonizer(c_1) \cdot Canonizer(c_2))\\
&= \llbracket \ell_1 \cdot  \ell_2 \rrbracket \circ Canonizer(c_1 \cdot c_2)
\end{align*}
Similarly
$$
  \llbracket q \rrbracket.put = \llbracket \ell_1 \cdot  \ell_2 \rrbracket^{-1}
  \circ Canonizer(d_1 \cdot d_2) $$
  \item
  $q = q_1 \; | \; q_2$ where $q_1 : c_1 \Leftrightarrow d_1 $, $q_2 : c_2
  \Leftrightarrow d_2$, $\mathcal{L}(W(c_1)) \cap \mathcal{L}(W(c_2)) =
  \varnothing$ and $\mathcal{L}(W(d_1)) \cap \mathcal{L}(W(d_2)) = \varnothing$.
  Then
  $$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket q_2 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_2))\\
  \end{cases}$$
  $$\llbracket q_1 \; | \; q_2 \rrbracket.put(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_1))\\
  \llbracket q_2 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_2))\\
  \end{cases}
  $$
By the induction hypothesis, there exist bijective lenses $\ell_1 : K(c_1)
\Leftrightarrow K(d_1)$ and $\ell_2 : K(c_2) \Leftrightarrow K(d_2)$ such that
\begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(d_1)
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2)\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonizer(d_2)
\end{align*}
Consequently,
$$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1) (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2) (s) & \text{if } s \in \mathcal{L}(W(c_2)),\\
  \end{cases}$$
  so $\llbracket q_1 \; | \; q_2 \rrbracket.get = \llbracket \ell_1 \; | \;
  \ell_2 \rrbracket \circ Canonizer(c_1 \; | \; c_2)$. A similar argument shows
  that $\llbracket q_1 \; | \; q_2 \rrbracket.put = \llbracket \ell_1 \; | \;
  \ell_2 \rrbracket^{-1} \circ Canonizer(d_1 \; | \; d_2)$.\\
  This completes the proof.
\end{enumerate}
\end{proof}
\section{Synthesizing Quotient Lenses}
By \cref{normal form}, if there is a derivation $q : c \Leftrightarrow c'$ in
$\mathcal{Q}$ then there exists a bijective lens $\ell : K(c) \Leftrightarrow
K(c')$ such that
\begin{align*}
\llbracket q \rrbracket.get &= \llbracket \ell \rrbracket\circ Canonizer(c)\\
\llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
Canonizer(c')
\end{align*}
In other words, every quotient lens in $\mathcal{Q}$ is the same as an ordinary
bijective lens with canonizers at the ends.\\
Therefore, in order to synthesize a quotient lens $q: c \Leftrightarrow c'$
where $c, c'$ are QREs, it suffices to synthesize a bijective lens $\ell : K(c)
\Leftrightarrow K(c')$.\\
\textcolor{red}{[Citation Needed!]} has already shown that if there
exists a derivation $\ell : R \Leftrightarrow S$, then there exist
regular expressions $R', S'$ and a synthesizable \\
\textcolor{red}{[Explain and make explicit the meaning
of synthesizable]} \\
bijective lens $\ell' :
R' \Leftrightarrow S'$ such that $\mathcal{L}(R) = \mathcal{L}(R')$,
$\mathcal{L}(S) = \mathcal{L}(S')$ and $\llbracket \ell \rrbracket =
\llbracket \ell' \rrbracket$. This immediately implies that if there is a
derivation $q : c \Leftrightarrow c'$ as well as a derivation $\ell : K(c)
\Leftrightarrow K(c')$, then $q$ is synthesizable.
\textcolor{red}{[More Needed?]}
\section{Implementation and Evaluation}
\section{Related Work}

\section{Conclusion}

\end{document}
