\documentclass{svproc}

\usepackage{amsmath, amssymb, verbatim, enumerate, 
graphicx, centernot, tikz, array, tikz-cd, extarrows, cleveref,
mathrsfs, mathtools, bussproofs, stmaryrd, enumitem, stackengine}

\begin{document}
\mainmatter              % start of a contribution
%
\title{A Synthesis Ready Langauge for Expressing Quotient Lenses}
%
\titlerunning{}  % abbreviated title (for running head)
%                                     also used for the TOC unless
%                                     \toctitle is used
%
\author{}
%
\authorrunning{} % abbreviated author list (for running head)
%
%%%% list of authors for the TOC (use if author list has to be modified)
\tocauthor{}
%
\institute{}

\maketitle              % typeset the title of the contribution

\begin{abstract}

\keywords{quotient lenses, quotient regular expressions, synthesis}
\end{abstract}

\section{Introduction}
TODO Introduce BibTex to Endnote example as motivation.
\subsection{Contributions}
\begin{enumerate}
  \item
  We introduce the language of Quotient Regular Expressions (QREs) which enables
  us to express a set of equivalence relations on regular languages using a
  compact, easy-to-use syntax.
  \item
  We describe a class $\mathcal{Q}$ of quotient lenses whose types are given by
  QREs. We derive a normal form for quotient lenses in $\mathcal{Q}$, and
  demonstrate that elements of $\mathcal{Q}$ that are in this normal form are
  closed under left quotienting, right quotienting, composition and regular
  operators.
  \item
  We give an algorithm for synthesizing quotient lenses in
  $\mathcal{Q}$ from their QRE types and a set of examples.
  \item
  We describe an implementation of QREs, the language $\mathcal{Q}$ of quotient
  lenses, and the algorithm for synthesizing quotient lenses in $\mathcal{Q}$ in
  the Boomerang language.
\end{enumerate}

\section{Quotient Regular Expressions}
The language of Quotient Regular Expressions (QREs) is given by the following
grammar:
$$q := id(R) \; | \; R \mapsto s \; | \; squash (R, R', f) \; | \; perm \;
(R_1, \ldots, R_n) \; with \; R \; | \; q' \circ q \; | \; q \cdot q' \; | \;
(q \; | \; q') \; | \; q^*,$$
where $R$ ranges over regular expressions, $f$ ranges over functions whose
domain and codomain are regular languages, and $s$ ranges over character
strings.\\
Each QRE $q$ enables us to express
\begin{enumerate}
  \item a regular expression $W(q)$ (the ``whole'' of $q$),
  \item an equivalence relation $EqRel(q)$ on $\mathcal{L}(W(q))$,
  \item a regular expression $K(q)$ (the ``kernel'' of $q$)
  such that $\mathcal{L}(K(q))$ forms a complete set of representatives for
  $EqRel(q)$, and
  \item a ``canonizing'' function $Canonizer(q):\mathcal{L}(W(q))
  \longrightarrow \mathcal{L}(K(q))$ which given any $w \in \mathcal{L}(W(q))$,
  computes $Canonizer(q)(w)$ as the unique $k$ in $\mathcal{L}(K(q))$ such that
  $k$ is equivalent to $w$ mod $EqRel(q)$
\end{enumerate}
Observe that since $Canonizer(q)$ computes
$Canonizer(q)(w)$ as the unique $k$ in $\mathcal{L}(K(q))$ such that $w$ is
equivalent to $k$ mod $EqRel(q)$, then the equivalence classes of $EqRel(q)$
are the same as the fibres of $Canonizer(q)$.
\subsection{Semantics of QREs}
We now give the semantics of QREs as well as inference rules for deriving them:
\begin{enumerate}
  \item $q = id(R)$
\begin{center}
\begin{enumerate}
  \item $W(id(R)) = R$,
  \item $K(id(R)) = R$, 
  \item
For all $w, w' \in W(id(R))$, $w \; EqRel(q) \; w'$ if and only if $w =
w'$.
\item
$Canonizer(id(R))(r) = r$
\end{enumerate}
\begin{prooftree}
\AxiomC{}
\UnaryInfC{$id(R)$ is well formed}
\end{prooftree}
\end{center}
\item $q=R \mapsto s$
\begin{center}
\begin{enumerate}
  \item $W(R \mapsto S) = R$,
  \item $K(R \mapsto s) = s$, 
  \item
For all $w, w' \in W(R \mapsto S)$, $w \; EqRel(R \mapsto S) \; w'$,
\item
$Canonizer(R \mapsto S)(r) = s$
\end{enumerate}
\begin{prooftree}
\AxiomC{$s \in \mathcal{L}(R)$}
\UnaryInfC{$R \mapsto s$ is well formed}
\end{prooftree}
\end{center}
\item $q=squash(R, R', f)$
\begin{center}
\begin{enumerate}
  \item $W(squash(R, R', f)) = R \; | \; R'$,
  \item $K(squash(R, R', f)) = R'$, 
  \item
For all $w, w' \in W(squash(R, R', f))$, $w \; EqRel(q) \; w'$ if and only
if $f(w) = w'$ or $w = w'$
\item
$Canonizer(squash(R, R', f))(w) = 
\begin{cases}
f(w) & \text{if } w \in \mathcal{L}(R)\\
w & \text{otherwise}
\end{cases}$
\end{enumerate}
\begin{prooftree}
\AxiomC{$\mathcal{L}(R) \cap \mathcal{L}(R') = \varnothing$}
\AxiomC{$f : \mathcal{L}(R) \longrightarrow \mathcal{L}(R')$}
\BinaryInfC{$squash(R, R', f)$ is well formed}
\end{prooftree}
\end{center}
\item $q=perm \; (R_1, \ldots, R_n) \; with \; S$
\begin{center}
\begin{enumerate}
  \item $W(perm \; (R_1, \ldots, R_n) \; with \; S) = \bigcup \limits_{\sigma
  \in S_n} R_{\sigma(1)} \cdot S \cdot \ldots \cdot \cdot S \cdot R_{\sigma(n)}$
,
  \item $K(perm \; (R_1, \ldots, R_n) \; with \; S) = R_{1} \cdot S
  \cdot \ldots \cdot \cdot S \cdot R_{n}$, 
  \item
For all $w, w' \in W(q)$,  $w \; EqRel(q) \; w'$ if and only if
   $$w = r_{\sigma(1)} \cdot s_1 \cdot \ldots \cdot s_{n-1} \cdot
    r_{\sigma(n)} \text{ and } r' = {r}_{\theta(1)} \cdot s_1 \cdot \ldots
    \cdot s_{n-1} \cdot {r}_{\theta(n)}$$ for some $\sigma, \theta \in
    S_n$, where $r_i \in R_i$ and $s_j \in S$.
\item
$Canonize(q)(r_{\sigma(1)}
\cdot s_1 \cdot \ldots \cdot s_{n-1} \cdot r_{\sigma(n)})
= r_1 \cdot s_1 \cdot \ldots \cdot \cdot s_{n-1}\cdot r_n$
\end{enumerate}
\begin{prooftree}
\AxiomC{$\forall \sigma \neq \theta, \; R_{\sigma(1)} \cdot S \cdot \ldots \cdot
S \cdot R_{\sigma(n)} \cap R_{\theta(1)} \cdot S \cdot \ldots \cdot S \cdot
R_{\theta(n)} = \varnothing$} \AxiomC{$\forall \sigma, \; R_{\sigma(1)} \cdot^!
S \cdot^! \ldots \cdot^! S \cdot^! R_{\sigma(n)}$}
\BinaryInfC{$permute \; (R_1, \ldots, R_n) \; with \;  S$ is well formed}
\end{prooftree}
\end{center}
\item $q=q' \circ q$
\begin{center}
\begin{enumerate}
  \item $W(q' \circ q) = W(q)$,
  \item $K(q' \circ q) = K(q')$, 
  \item
For all $w, w' \in W(squash(R, R', f))$, $w \; EqRel(q' \circ q) \; w'$ if and
only $$\text{there exist }k, k' \in
  \mathcal{L}(K(q)) \text{ such that } w \; EqRel(q) \; k, \; w' \;
  EqRel(q) \; k', \text{ and } k \; EqRel(q') \; k' $$
\item
$Canonizer(q' \circ q) = Canonizer(q') \circ Canonizer(q)
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$K(q) = W(q')$}
\TrinaryInfC{$q' \circ q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q \cdot q'$
\begin{center}
\begin{enumerate}
  \item $W(q \cdot q') = W(q) \cdot W(q')$,
  \item $K(q \cdot q') = K(q) \cdot K(q')$, 
  \item
For all $w, w' \in W(q \cdot q')$, $w \; EqRel(q' \cdot q) \; w'$ if and
only $$w = r_1
      \cdot r_2, \; w' = {r'}_1 \cdot {r'}_2 \text{ with } r_1 \; EqRel(q) \;
      {r'}_1, \; r_2 \; EqRel(q') \; {r'}_2$$
\item
$Canonizer(q \cdot q') = Canonizer(q) \cdot Canonizer(q')
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$W(q) \cdot^! W(q')$}
\AxiomC{$K(q) \cdot^! K(q')$}
\QuaternaryInfC{$q \cdot q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q \; | \;  q'$
\begin{center}
\begin{enumerate}
  \item $W(q \cdot q') = W(q) \; | \; W(q')$,
  \item $K(q \cdot q') = K(q) \; | \; K(q')$, 
  \item
For all $w, w' \in W(q \; | \; q')$, $w \; EqRel(q' \; | \; q) \; w'$ if and
only if 
$$w \; EqRel(q) \; w' \text{ or } \; w \; EqRel(q') \; w'$$
\item
$Canonizer(q \; | \; q') = Canonizer(q) \; | \; Canonizer(q')
$
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$q'$ is well formed}
\AxiomC{$W(q) \cap W(q') = \varnothing$}
\TrinaryInfC{$q \cdot q$ is well formed}
\end{prooftree}
\end{center}
\item $q=q'^*$
\begin{center}
\begin{enumerate}
  \item $W(q'^*) = W(q')^*$,
  \item $K(q'^*) = K(q')^*$, 
  \item
For all $w, w' \in W(q'^*)$, $w \; EqRel(q'^*) \; w'$ if and
only if 
$$w = r_1 \cdot \ldots \cdot r_n, \; w' = {r'}_1 \cdot \ldots
      \cdot {r'}_n \text{ and } r_i \; EqRel(q) \; {r'}_i
      \text{ for all } 1 \leq i \leq n$$
      \item
$Canonizer(q'^*) = Canonizer(q')^* $
\end{enumerate}
\begin{prooftree}
\AxiomC{$q$ is well formed}
\AxiomC{$W(q)^{*!}$}
\AxiomC{$K(q)^{*!}$}
\TrinaryInfC{$q^*$ is well formed}
\end{prooftree}
\end{center}
\end{enumerate}
\begin{claim}
If $q$ is a well formed QRE, then
\begin{enumerate}
  \item  $EqRel(q)$ is an equivalence relation on $\mathcal{L}(W(q))$,
  \item  $\mathcal{L}(K(q))$ forms a complete set of representatives for
  $EqRel(q)$,
  \item $Canonizer(q):\mathcal{L}(W(q)) \longrightarrow \mathcal{L}(K(q))$ is a
  well-defined function, and
  \item  given any $w \in \mathcal{L}(W(q))$, $Canonizer(q)(w)$ is the unique
  $k$ in $\mathcal{L}(K(q))$ such that $k$ is equivalent to $w$ modulo
  $EqRel(q)$
  \end{enumerate}
\end{claim}
\section{Using QREs to Express Quotient Lenses}
Given regular expressions $R, S$ and equivalence relations $\sim_R, \sim_S$ are
defined on $\mathcal{L}(R)$ and $\mathcal{L}(S)$ respectively, a
\textit{quotient lens} $q :
R/{\sim_R}{\Longleftrightarrow} S/{\sim_S}$ from $R$ to $S$ is
a pair of functions $q.get:
\mathcal{L}(R) \longrightarrow \mathcal{L}(S)$ and $q.put : \mathcal{L}(S)
\longrightarrow \mathcal{L}(R)$ such that
\begin{align*}
q.put \; (q.get \; r) &\sim_R r\\
q.get \; (q.put \; s) &\sim_S s
\end{align*}
Additionally the components of $q$ must respect $\sim_R$ and $\sim_S$ i.e.
if $r \sim_R r'$ and $s \sim_S s'$ then $q.get \; r \; \sim_S q.get \; r'$
and $q.put \; s \sim_R q.put \; s' \; s'$.\\
Now let $c, c'$ be QREs. Since $K(c)$ and $K(c')$ form a complete set of
representatives for $W(c)$ modulo $EqRel(c)$ and $W(c')$ modulo $EqRel(c')$
respectively, then given a bijection $\ell : K(c) \Leftrightarrow K(c')$, we
may define a quotient lens $q : W(c)/EqRel(c) \Leftrightarrow
W(c')/EqRel(c')$ by 
\begin{align*}
q.get &= \ell \circ Canonizer(c)\\
q.put &= \ell^{-1} \circ Canonizer(c')
\end{align*}
[Reference needed] Define the class of \textit{bijective lenses} to be the set
of bijections between regular languages created from Boomerang lens combinators.
The syntax for the language of bijective lenses is given by
$$\ell := id(R) \; | \; const(s, s') \; | \;  swap(\ell,
\ell) \; | \; \ell \cdot \ell' \; |  \; (\ell \; | \; \ell') \; | \; \ell^* \;
| \; \ell \circ \ell',$$ where $R$ ranges over regular expressions and $s$
ranges over character strings.\\
The denotation of a bijective lens $\ell$ is a function from 
$\llbracket e \rrbracket$ of a bijective lens $\ell$ is defined
inductively by
\begin{align*}
\llbracket id(R) \rrbracket &= \{(r, r) \; | \; r \in \mathcal{L}(R)\}\\
\llbracket swap(\ell, \ell') \rrbracket &= \{(s \cdot t, t' \cdot s') \; | \;
(s, s') \in \llbracket \ell \rrbracket \text{ and } (t, t') \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell \cdot \ell' \rrbracket &= \{(s \cdot t, s' \cdot t) \; | \;
(s, s') \in \llbracket \ell \rrbracket \text{ and } (t, t') \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell \; | \; \ell' \rrbracket &= \{(s \cdot t) \; | \;
(s, t) \in \llbracket \ell \rrbracket \text{ or } (s, t) \in \llbracket
\ell' \rrbracket\}\\
\llbracket \ell^* \rrbracket &= \{(s_1 \cdot \ldots \cdot s_n, t_1 \cdot \ldots
\cdot t_n) \; | \; (s_i, t_i) \in \llbracket \ell \rrbracket \text{ for } 1
\leq i \leq n\}
\end{align*}
Having described the class of bijective lenses, we now define the class
$\mathcal{Q}$ of quotient lenses, whose language is defined inductively by the
following grammar:
$$ q := id(\ell) \; | \; lquot(q, \ell) \; | \; rquot(\ell, q) \; | \; q
\cdot q_2 \; | \; (q \; | \; q') \; | \; q^* \; | \; q \circ q',$$
where $\ell$ ranges over bijective lenses 
\subsection{Semantics of $\mathcal{Q}$}
Every element in $\mathcal{Q}$ has a type $q :
c \Longleftrightarrow c'$ where $c$ and $c'$ are QREs. The denotation
$\llbracket q \rrbracket$ of an element $q : c \Longleftrightarrow c'$ is a
quotient lens $\llbracket q \rrbracket :
W(c)/{EqRel(c)} \Longleftrightarrow W(c')/{EqRel(c')}$. We now give the
semantics of $\mathcal{Q}$, as well as inference rules that may be used to
derive elements of $\mathcal{Q}$:
\begin{enumerate}
  \item
  if $q = id(\ell)$, then
  \begin{prooftree}
\AxiomC{$\ell : R \Leftrightarrow S$}
\UnaryInfC{$id(\ell): id(R) \Leftrightarrow id(S)$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &=  \llbracket \ell \rrbracket, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1}
  \end{align*}
 
  \item if $q = lquot(c, q')$, then
\begin{prooftree}
\AxiomC{$q' : c'  \Leftrightarrow c''$}
\AxiomC{$c$ is well formed}
\AxiomC{$K(c) = W(c')$}
\TrinaryInfC{$lquot(c, q'): c' \circ c \Leftrightarrow c''$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get  &= \llbracket q'
  \rrbracket.get \circ Canonizer(c)\\
  \llbracket q \rrbracket.put &= \llbracket q' \rrbracket.put
  \end{align*}
  \item
  if $q = rquot(q', c'')$, then
  \begin{prooftree}
  \AxiomC{$q' : c \Leftrightarrow c'$}
  \AxiomC{$c''$ is well formed}
  
\AxiomC{$K(c'') = W(c')$}
\TrinaryInfC{$rquot(q', c):c \Leftrightarrow c'' \circ c'$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q'
  \rrbracket.get\\
  \llbracket q \rrbracket.put &= \llbracket q'
  \rrbracket.put \circ Canonizer(c'')
  \end{align*}
  
  \item
  $q = q_2 \circ q_1$, then
  \begin{prooftree}
\AxiomC{$q_1 : c \Leftrightarrow c'$}
\AxiomC{$q_2 : c' \Leftrightarrow c''$}
\BinaryInfC{$q_2 \circ q_1: c \Leftrightarrow c''$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_2 \rrbracket.get\circ \llbracket
  q_1 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \circ \llbracket
  q_2 \rrbracket.put
  \end{align*}
  \item
  $q = {q'}^*$, then
    \begin{prooftree}
\AxiomC{$q' : c \Leftrightarrow c'$}
\AxiomC{$W(c)^{*!}$ and $W(c')^{*!}$}
\AxiomC{$K(c)^{*!}$ and $K(c')^{*!}$}
\TrinaryInfC{${q'}^* : c^* \Leftrightarrow {c'}^*$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= (\llbracket q' \rrbracket.get)^*, \text{
  and }\\
  \llbracket q \rrbracket.put &= (\llbracket q' \rrbracket.put)^*
  \end{align*}

  \item
  $q = q_1 \cdot q_2$, then
    \begin{prooftree}
\AxiomC{$q_1 : c_1 \Leftrightarrow d_1 $}
\AxiomC{$q_2 : c_2 \Leftrightarrow d_2$}
\AxiomC{${\substack{W(c_1) \cdot^! W(c_2)\\ K(c_1) \cdot^! K(c_2)}}$}
\AxiomC{${\substack{W(d_1) \cdot^! W(d_2)\\ K(d_1) \cdot^! K(d_2)}}$}
\QuaternaryInfC{$q_1 \cdot q_2: c_1 \cdot c_2
\Leftrightarrow d_1 \cdot d_2$}
\end{prooftree}
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_1 \rrbracket.get \cdot \llbracket
  q_2 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \cdot \llbracket
  q_2 \rrbracket.put
  \end{align*}

  \item
  $q = q_1 \; | \; q_2$, then
      \begin{prooftree}
\AxiomC{$q_1 : c_1 \Leftrightarrow d_1 $}
\AxiomC{$q_2 : c_2 \Leftrightarrow d_2$}
\AxiomC{$\mathcal{L}(W(c_1)) \cap \mathcal{L}(W(c_2)) = \varnothing$}
\AxiomC{$\mathcal{L}(W(d_1)) \cap \mathcal{L}(W(d_2)) = \varnothing$}
\QuaternaryInfC{$q_1 \; | \; q_2: (c_1 \; | \; c_2)
\Leftrightarrow (d_1 \; | \; d_2)$}
\end{prooftree}
  $$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket q_2 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_2))\\
  \end{cases}$$
  $$\llbracket q_1 \; | \; q_2 \rrbracket.put(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_1))\\
  \llbracket q_2 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_2))\\
  \end{cases}
  $$
\end{enumerate}

\begin{claim}
If there exists a derivation $q:c \Leftrightarrow c'$ then
$\llbracket q \rrbracket$ is a quotient lens from $R$ to $S$.
\end{claim}

\subsection{Normal Forms for Quotient Lenses in $\mathcal{Q}$}
\begin{claim}
If there is a derivation $q : c \Leftrightarrow c'$ in
$\mathcal{Q}$ then there exists a bijective lens $\ell : K(c) \Leftrightarrow
K(c')$ such that
\begin{align*}
\llbracket q \rrbracket.get &= \llbracket \ell \rrbracket\circ Canonizer(c)\\
\llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
Canonizer(c')
\end{align*}
\end{claim}
\begin{proof}
Assume that $q : c \Leftrightarrow c'$. We proceed by induction over the
derivation $q : c \Leftrightarrow c'$.
\begin{enumerate}
  \item
  $id(\ell): id(R) \Leftrightarrow id(S)$ where $\ell : R \Leftrightarrow
S$. Then
  \begin{align*}
  \llbracket id(\ell) \rrbracket.get &=  \llbracket \ell \rrbracket = \llbracket \ell \rrbracket \circ
  id_{\mathcal{L}(R)} = \llbracket \ell \rrbracket \circ Canonizer(id(R)), \text{ and }\\
  \llbracket id(\ell) \rrbracket.put &= \llbracket \ell \rrbracket^{-1} = \llbracket \ell \rrbracket^{-1} \circ
  id_{\mathcal{L}(S)} = \llbracket \ell \rrbracket^{-1} \circ Canonizer(id(S))
  \end{align*}
  \item
  $lquot(c, q'): c' \circ c \Leftrightarrow c''$ where $q' : c' 
  \Leftrightarrow c''$, $c$ is well formed and $K(c) = W(c')$. Then
\begin{align*}
  \llbracket q \rrbracket.get  &= \llbracket q'
  \rrbracket.get \circ Canonizer(c)\\
  \llbracket q \rrbracket.put &= \llbracket q' \rrbracket.put
  \end{align*}
  By the induction hypothesis, there exists a bijective lens $\ell :
  K(c') \Leftrightarrow K(c'')$ such that 
  \begin{align*}
\llbracket q' \rrbracket.get &= \llbracket \ell \rrbracket \circ Canonizer(c')\\
\llbracket q' \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
Canonize(c'')
\end{align*}
Consequently
\begin{align*}
  \llbracket q \rrbracket.get  &= (\llbracket \ell \rrbracket \circ
  Canonizer(c')) \circ Canonizer(c) = \llbracket \ell \rrbracket \circ
  (Canonizer(c' \circ c))\\
  \llbracket q \rrbracket.put &= \llbracket \ell \rrbracket^{-1} \circ
  Canonize(c'')
  \end{align*}

  \item
  $rquot(q', c''):c \Leftrightarrow c'' \circ c'$ where $q' : c \Leftrightarrow
  c'$, $c''$ is well formed and $K(c'') = W(c')$. Proceed as in the previous
  case.
\item
$q_2 \circ q_1: c \Leftrightarrow c''$ where $q_1 : c \Leftrightarrow c'$ and
$q_2 : c' \Leftrightarrow c''$. Then
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_2 \rrbracket.get\circ \llbracket
  q_1 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \circ \llbracket
  q_2 \rrbracket.put
  \end{align*}
  By the induction hypothesis, there exist bijective lenses
  $\ell_1 :
  K(c) \Leftrightarrow K(c')$ and $\ell_2 : K(c') \Leftrightarrow K(c'')$ such
  that
  \begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(c')
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonize(c')\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonize(c'')
\end{align*}
Consequently,
\begin{align*}
\llbracket q_2 \rrbracket.get \circ \llbracket q_1 \rrbracket.get &=
(\llbracket \ell_2 \rrbracket \circ Canonizer(c')) \circ (\llbracket \ell_1
\rrbracket \circ Canonizer(c))\\
&= \llbracket \ell_2 \rrbracket \circ (Canonizer(c') \circ \llbracket \ell_1
\rrbracket) \circ Canonizer(c)\\
&= (\llbracket \ell_2 \rrbracket \circ \llbracket \ell_1 \rrbracket) \circ
Canonizer(c)\\
&= \llbracket \ell_2  \circ  \ell_1 \rrbracket \circ
Canonizer(c)
\end{align*} 
A similar argument shows that 
$$\llbracket q_1 \rrbracket.put \circ \llbracket q_2 \rrbracket.put =
\llbracket \ell_2  \circ  \ell_1 \rrbracket^{-1} \circ
Canonizer(c)$$
\item  
${q'}^* : c^* \Leftrightarrow {c'}^*$ where $q' : c \Leftrightarrow c'$,
$W(c)^{*!}$ and $W(c')^{*!}$ and $K(c)^{*!}$ and $K(c')^{*!}$. Then
  \begin{align*}
  \llbracket {q'}^* \rrbracket.get &= (\llbracket q' \rrbracket.get)^*, \text{
  and }\\
  \llbracket {q'}^* \rrbracket.put &= (\llbracket q' \rrbracket.put)^*
  \end{align*}
  By the induction hypothesis there exists a bijective lens $\ell : K(c)
  \Leftrightarrow K(c')$ such that 
   that
  \begin{align*}
\llbracket q' \rrbracket.get &= \llbracket \ell \rrbracket \circ
Canonizer(c)\\
\llbracket q' \rrbracket.put &= {\llbracket \ell \rrbracket}^{-1} \circ
Canonizer(c')
\end{align*}
Consequentlty
\begin{align*}
\llbracket {q'}^* \rrbracket.get &= (\llbracket \ell \rrbracket \circ
Canonizer(c))^* = \llbracket \ell \rrbracket^* \circ
Canonizer(c)^* = \llbracket \ell^* \rrbracket \circ
Canonizer(c^*)\\
\llbracket {q'}^* \rrbracket.put &= (\llbracket \ell \rrbracket^{-1} \circ
Canonizer(c'))^* = (\llbracket \ell \rrbracket^{-1})^* \circ
Canonizer(c')^* = \llbracket \ell^* \rrbracket^{-1} \circ
Canonizer(c'^*)\\
\end{align*}
\item
  $q_1 \cdot q_2: c_1 \cdot c_2 \Leftrightarrow d_1 \cdot d_2$, where $q_1 : c_1
  \Leftrightarrow d_1 $,  $q_2 : c_2 \Leftrightarrow d_2$, $W(c_1)
  \cdot^! W(c_2)$, $K(c_1) \cdot^! K(c_2)$, $W(d_1) \cdot^! W(d_2)$ and $
  K(d_1) \cdot^! K(d_2)$. Then
  \begin{align*}
  \llbracket q \rrbracket.get &= \llbracket q_1 \rrbracket.get \cdot \llbracket
  q_2 \rrbracket.get, \text{ and }\\
  \llbracket q \rrbracket.put &= \llbracket q_1 \rrbracket.put \cdot \llbracket
  q_2 \rrbracket.put
  \end{align*}
By the induction hypothesis, there exist bijective lenses $\ell_1 : K(c_1)
\Leftrightarrow K(d_1)$ and $\ell_2 : K(c_2) \Leftrightarrow K(d_2)$ such that
\begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(d_1)
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2)\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonizer(d_2)
\end{align*}
Consequently,
\begin{align*}
  \llbracket q \rrbracket.get &= (\llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)) \cdot  (\llbracket \ell_2 \rrbracket \circ
Canonizer(c_2))\\
&= (\llbracket \ell_1 \rrbracket \cdot \llbracket \ell_2
\rrbracket) \circ (Canonizer(c_1) \cdot Canonizer(c_2))\\
&= \llbracket \ell_1 \cdot  \ell_2 \rrbracket \circ Canonizer(c_1 \cdot c_2)
\end{align*}
Similarly
$$
  \llbracket q \rrbracket.put = \llbracket \ell_1 \cdot  \ell_2 \rrbracket^{-1}
  \circ Canonizer(d_1 \cdot d_2) $$
  \item
  $q = q_1 \; | \; q_2$ where $q_1 : c_1 \Leftrightarrow d_1 $, $q_2 : c_2
  \Leftrightarrow d_2$, $\mathcal{L}(W(c_1)) \cap \mathcal{L}(W(c_2)) =
  \varnothing$ and $\mathcal{L}(W(d_1)) \cap \mathcal{L}(W(d_2)) = \varnothing$.
  Then
  $$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket q_2 \rrbracket.get (s) & \text{if } s \in \mathcal{L}(W(c_2))\\
  \end{cases}$$
  $$\llbracket q_1 \; | \; q_2 \rrbracket.put(s) = 
  \begin{cases}
  \llbracket q_1 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_1))\\
  \llbracket q_2 \rrbracket.put (s) & \text{if } s \in \mathcal{L}(W(d_2))\\
  \end{cases}
  $$
By the induction hypothesis, there exist bijective lenses $\ell_1 : K(c_1)
\Leftrightarrow K(d_1)$ and $\ell_2 : K(c_2) \Leftrightarrow K(d_2)$ such that
\begin{align*}
\llbracket q_1 \rrbracket.get &= \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1)\\
\llbracket q_1 \rrbracket.put &= {\llbracket \ell_1 \rrbracket}^{-1} \circ
Canonizer(d_1)
\end{align*}
and
\begin{align*}
\llbracket q_2 \rrbracket.get &= \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2)\\
\llbracket q_2 \rrbracket.put &= {\llbracket \ell_2 \rrbracket}^{-1} \circ
Canonizer(d_2)
\end{align*}
Consequently,
$$
  \llbracket q_1 \; | \; q_2 \rrbracket.get(s) = 
  \begin{cases}
  \llbracket \ell_1 \rrbracket \circ
Canonizer(c_1) (s) & \text{if } s \in \mathcal{L}(W(c_1))\\
  \llbracket \ell_2 \rrbracket \circ
Canonizer(c_2) (s) & \text{if } s \in \mathcal{L}(W(c_2)),\\
  \end{cases}$$
  so $\llbracket q_1 \; | \; q_2 \rrbracket.get = \llbracket \ell_1 \; | \;
  \ell_2 \rrbracket \circ Canonizer(c_1 \; | \; c_2)$. A similar argument shows
  that $\llbracket q_1 \; | \; q_2 \rrbracket.put = \llbracket \ell_1 \; | \;
  \ell_2 \rrbracket^{-1} \circ Canonizer(d_1 \; | \; d_2)$.\\
  This completes the proof.
\end{enumerate}
\end{proof}
\section{Synthesizing Quotient Lenses}
\section{Related Work}

\section{Conclusion}

\end{document}
